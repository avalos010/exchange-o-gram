{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container" style="margin-top: 100px">
<h3 class="text-center"> Posts </h3>

{% if posts %}
{% for post in posts  %}
<div class=" d-flex flex-column justify-content-center mt-3 col-lg-8" >
    <div class="d-flex flex-row align-items-center mb-2">
        <img class="rounded-circle mr-2" src='{{post.profile.photo.url}}' width="40" height='40' />
        <a class="text-dark" href='{% url 'profile' post.profile %}'>{{post.profile}}</a>
    </div>
    <figure class="figure p-3 border">
    <img src="{{post.image.url}}" class="figure-img img-fluid mx-auto d-block"/>
    <figcaption class="figure-caption">  
    {{post.body}}
    </figcaption>
    <div class="d-flex flex-row mt-2">
    {% if user.userprofile in post.likes.all %}
    <i  onclick="unlikepost('{{post.id}}')" style="cursor:pointer" class="fas fa-heart fa-2x mr-2"></i>
    {% else %}
    <i onclick="likepost('{{post.id}}')" style="cursor:pointer" class="far fa-heart fa-2x mr-2"></i>
    {% endif %}
  <i style="cursor:pointer" class="far fa-comment fa-2x mr-2"></i>
    </div>
    <p class="mt-2"><b>{{post.likes.count}} likes</b></p>
    <p class="text-right"><small class="timesince">{{post.date|timesince}}</small></p>

    {% if comments %}
    <div class="d-flex flex-column mb-1">
      {% for comment in comments %}
      {% if comment.post.id == post.id %}
        <div class="d-flex flex-row align-items-center border p-2">
        <a class="text-dark mr-2 font-weight-bold" href="{% url 'profile' comment.author %}">
        {{comment.author}}
        </a>
        <small>
        {{comment.body}}
        </small>
        </div>
        </div>
        {% endif %}
      {% endfor %}
    {% endif %}
    </figure>
</div>


{% endfor %}
{% else %}
{% endif %}



</form>
</div>
<script>
function getCsrf() {
    var inputElems = document.querySelectorAll('input');
    var csrfToken = '';
    for (i = 0; i < inputElems.length; ++i) {
        if (inputElems[i].name === 'csrfmiddlewaretoken') {
            csrfToken = inputElems[i].value;
            break;
        }
    }
    return csrfToken;
};
const csrf_token = getCsrf()

const likepost = (id) => {
  fetch("{% url 'like_post' %}",{
    headers: {
      'X-CSRFTOKEN': csrf_token
    },
    method: 'POST',
    body: JSON.stringify({id: id})
  })

  location.reload()
}

const unlikepost = (id) => {
  fetch("{% url 'unlike_post' %}",{
    headers: {
      'X-CSRFTOKEN': csrf_token
    },
    method: 'POST',
    body: JSON.stringify({id: id})
  })

  location.reload()
}
</script>
{% endblock %}

